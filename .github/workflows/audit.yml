name: Django CI/CD

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ main ]

env:
  DEBUG: True
  DB_ENGINE: django.db.backends.postgresql
  ALLOWED_HOSTS: localhost,127.0.0.1
  POSTGRES_HOST: localhost
  POSTGRES_PORT: 5440
  POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
  POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
  SECRET_KEY: ${{ secrets.SECRET_KEY }}
  LAUNCHDARKLY_SDK_KEY: ${{ secrets.LAUNCHDARKLY_SDK_KEY }}
  LDCLIENT_ID: ${{ secrets.LDCLIENT_ID }}

jobs:
  bandit:
    runs-on: ubuntu-latest
    name: An치lisis de seguridad con Bandit
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Instalar Bandit
        run: pip install bandit[toml]

      - name: Ejecutar Bandit
        run: |
          bandit -r . -f json -o bandit-report.json || true

      - name: Subir reporte como artefacto
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

  sqlmap:
    runs-on: ubuntu-latest
    name: Detecci칩n de inyecciones SQL con SQLMap
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
        ports:
          - 5440:5432
        options: >-
          --health-cmd="pg_isready -U django -d django_db"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Levantar aplicaci칩n Django (para que SQLMap tenga endpoints)
        env:
          DEBUG: True
          SECRET_KEY: ci-secret-key
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5440
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        run: |
          pip install -r requirements.txt
          python manage.py migrate --noinput
          python manage.py runserver 0.0.0.0:8000 &
          sleep 10   # dar tiempo a que arranque

      - name: Instalar SQLMap
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlmap

      - name: Ejecutar SQLMap (escaneo b치sico)
        run: |
          sqlmap -u "http://localhost:8000/" \
                 --batch \
                 --crawl=2 \
                 --level=1 \
                 --risk=1 \
                 --exclude-sysdbs \
                 --flush-session \
                 -o \
                 --output-dir=sqlmap-output || true

      - name: Subir resultados de SQLMap
        uses: actions/upload-artifact@v4
        with:
          name: sqlmap-report
          path: sqlmap-output/